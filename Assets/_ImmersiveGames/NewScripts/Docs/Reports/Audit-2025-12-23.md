# Auditoria NewScripts — 2025-12-23

Escopo: apenas leitura/análise. Nenhum script C# alterado.

## Tarefa A — Diretórios e convenções atuais

### Árvores (limitadas)
- `Assets/_ImmersiveGames/NewScripts`
```
Assets/_ImmersiveGames/NewScripts
Assets/_ImmersiveGames/NewScripts/Configs
Assets/_ImmersiveGames/NewScripts/Configs/Worlds
Assets/_ImmersiveGames/NewScripts/QA
Assets/_ImmersiveGames/NewScripts/QA/Prefabs
Assets/_ImmersiveGames/NewScripts/Infrastructure
Assets/_ImmersiveGames/NewScripts/Infrastructure/QA
Assets/_ImmersiveGames/NewScripts/Infrastructure/Fsm
Assets/_ImmersiveGames/NewScripts/Infrastructure/DebugLog
Assets/_ImmersiveGames/NewScripts/Infrastructure/Actors
Assets/_ImmersiveGames/NewScripts/Infrastructure/Scene
Assets/_ImmersiveGames/NewScripts/Infrastructure/Predicates
Assets/_ImmersiveGames/NewScripts/Infrastructure/Cameras
Assets/_ImmersiveGames/NewScripts/Infrastructure/DI
Assets/_ImmersiveGames/NewScripts/Infrastructure/Ids
Assets/_ImmersiveGames/NewScripts/Infrastructure/Execution
Assets/_ImmersiveGames/NewScripts/Infrastructure/Events
Assets/_ImmersiveGames/NewScripts/Infrastructure/World
Assets/_ImmersiveGames/NewScripts/Infrastructure/State
Assets/_ImmersiveGames/NewScripts/Gameplay
Assets/_ImmersiveGames/NewScripts/Gameplay/GameLoop
Assets/_ImmersiveGames/NewScripts/Gameplay/Player
Assets/_ImmersiveGames/NewScripts/Docs
Assets/_ImmersiveGames/NewScripts/Docs/ADR
Assets/_ImmersiveGames/NewScripts/Docs/QA
Assets/_ImmersiveGames/NewScripts/Docs/Guides
Assets/_ImmersiveGames/NewScripts/Docs/WorldLifecycle
Assets/_ImmersiveGames/NewScripts/Docs/Migrations
Assets/_ImmersiveGames/NewScripts/Docs/GameLoop
Assets/_ImmersiveGames/NewScripts/Bridges
Assets/_ImmersiveGames/NewScripts/Bridges/LegacySceneFlow
Assets/_ImmersiveGames/NewScripts/Prefabs
```

- `Assets/_ImmersiveGames/Scripts` (legado)
```
Assets/_ImmersiveGames/Scripts
Assets/_ImmersiveGames/Scripts/GameManagerSystems
Assets/_ImmersiveGames/Scripts/GameManagerSystems/Docs
Assets/_ImmersiveGames/Scripts/GameManagerSystems/Events
Assets/_ImmersiveGames/Scripts/StateMachineSystems
Assets/_ImmersiveGames/Scripts/StateMachineSystems/GameStates
Assets/_ImmersiveGames/Scripts/StateMachineSystems/Docs
... (demais subpastas legadas de sistemas/Docs/Tests)
```

- `Docs/`
```
Docs/CHANGELOG.md
```

### Onde estão os documentos do NewScripts hoje
- Diretório dedicado: `Assets/_ImmersiveGames/NewScripts/Docs`, com subpastas ADR, QA, Guides, WorldLifecycle, Migrations, GameLoop e Reports (novo para esta auditoria).

## Tarefa B — Auditoria de dependências (NewScripts → Legado)

Referências encontradas em `Assets/_ImmersiveGames/NewScripts` para namespaces legados e uso de reflexão.

| Arquivo | Tipo | Referência encontrada | Severidade | Observação |
| --- | --- | --- | --- | --- |
| `Assets/_ImmersiveGames/NewScripts/Bridges/LegacySceneFlow/LegacySceneFlowBridge.cs` | Bridge/Adapter | `_ImmersiveGames.Scripts.SceneManagement.*`; `System.Reflection` | OK | Bridge oficial para refletir eventos de Scene Flow legado no EventBus NewScripts. Reflexão usada para mapear contextos dinâmicos. |
| `Assets/_ImmersiveGames/NewScripts/Bridges/LegacySceneFlow/LegacySceneFlowAdapters.cs` | Bridge/Adapter | `_ImmersiveGames.Scripts.FadeSystem.*`, `SceneManagement.*`; alias `LegacyDependencyManager` | OK | Adapter para reutilizar loader/fade legado quando disponível; dentro de `Bridges`. |
| `Assets/_ImmersiveGames/NewScripts/Infrastructure/QA/LegacySceneFlowBridgeSmokeQATester.cs` | QA/Infra | `_ImmersiveGames.Scripts.SceneManagement.Transition.*` | Suspeito | Referência ao legado fora de `Bridges/`; motivação: QA para validar bridge, mas ainda acopla namespaces legados diretamente. |
| `Assets/_ImmersiveGames/NewScripts/Infrastructure/Events/EventBusUtil.cs` | Infra | `System.Reflection` | OK | Reflexão para limpar buses genéricos; sem dependência do legado. |
| `Assets/_ImmersiveGames/NewScripts/Infrastructure/DI/DependencyInjector.cs` | Infra | `System.Reflection` | OK | Reflexão para descobrir campos anotados e resolver serviços via registries. |
| `Assets/_ImmersiveGames/NewScripts/Infrastructure/QA/NewScriptsInfraSmokeRunner.cs` | QA/Infra | `System.Reflection` | OK | Reflexão usada para invocar `Run()` de testers registrados via inspector. |
| `Assets/_ImmersiveGames/NewScripts/QA/WorldLifecycleAutoTestRunner.cs` | QA/Gameplay | `System.Reflection` | OK | Reflexão para localizar métodos/atributos durante auto-testes de lifecycle. |
| `Assets/_ImmersiveGames/NewScripts/Prefabs/Dummy.prefab` | Prefab | `m_ReflectionProbeUsage` | OK | Configuração de probe gráfica; não é dependência de legado. |
| `Assets/_ImmersiveGames/NewScripts/QA/Prefabs/Player_NewScripts.prefab` | Prefab | `m_ReflectionProbeUsage` | OK | Configuração gráfica; sem vínculo de código. |

Destaque: a única referência ao legado fora de `Bridges/` é `Infrastructure/QA/LegacySceneFlowBridgeSmokeQATester.cs` (QA). Nenhuma ocorrência de `using Legacy` fora do bridge/QA.

## Tarefa C — Scene Flow / SceneTransitionService

- **Flag nativa**: `NEWSCRIPTS_SCENEFLOW_NATIVE` é verificada em `Assets/_ImmersiveGames/NewScripts/Infrastructure/GlobalBootstrap.cs` via `#if` em `IsSceneFlowNativeEnabled()`. Quando definida, `RegisterSceneFlowNative()` registra `SceneTransitionService` no DI global; quando ausente, loga que o nativo está desativado e fica só o bridge legado.
- **SceneTransitionService nativo**: `Assets/_ImmersiveGames/NewScripts/Infrastructure/Scene/SceneTransitionService.cs`. Emite eventos `SceneTransitionStarted/ScenesReady/Completed` do NewScripts, com gate de semáforo para evitar concorrência e adapters para loader/fade.
- **LegacySceneFlowBridge**: `Assets/_ImmersiveGames/NewScripts/Bridges/LegacySceneFlow/LegacySceneFlowBridge.cs` + adapters em `LegacySceneFlowAdapters.cs`. Registrado pelo `GlobalBootstrap.RegisterLegacySceneFlowBridge()` mesmo quando o nativo está desativado.
- **Smoke testers**:
  - `Assets/_ImmersiveGames/NewScripts/Infrastructure/QA/SceneTransitionServiceSmokeQATester.cs` (ContextMenu `QA/SceneFlow/SceneTransitionService/Run`; também executado pelo `NewScriptsInfraSmokeRunner` quando `runSceneTransitionServiceTester=true`). Usa stubs para validar ordem Started → ScenesReady → Completed, integração com `GameReadinessService` e `SimulationGateService`.
  - `Assets/_ImmersiveGames/NewScripts/Infrastructure/QA/LegacySceneFlowBridgeSmokeQATester.cs` valida reflexão de eventos legados para o EventBus NewScripts (ContextMenu `QA/SceneFlow/Legacy Bridge/Run`).
- **Como habilitar/desabilitar fluxo nativo**: Definir/omitir a symbol `NEWSCRIPTS_SCENEFLOW_NATIVE` (Player Settings/Scripting Define Symbols). O `GlobalBootstrap` só registra o serviço nativo quando a flag está definida; caso contrário, mantém apenas o bridge. Consumidores podem coexistir porque o bridge continua ativo.
- **Critérios atuais para remover o bridge** (de `Docs/ADR/ADR-0001-NewScripts-Migracao-Legado.md#bridges-temporários-legacysceneflowbridge`): SceneTransitionService nativo sendo fonte primária (flag ativa), QAs do SceneTransitionServiceSmokeQATester verdes em produção e nenhum consumidor dependente dos eventos legados; depois remover registro no GlobalBootstrap e deletar `Bridges/LegacySceneFlow`.
- **Como rodar testes**: usar o `NewScriptsInfraSmokeRunner` (ContextMenu `QA/Infra/Run All` ou `runOnStart=true`), ou executar os testers individuais via ContextMenu nos componentes (`SceneTransitionServiceSmokeQATester.Run()`, `LegacySceneFlowBridgeSmokeQATester.Run()`).

## Tarefa D — WorldLifecycle Baseline

- **Localizações**:
  - `WorldLifecycleController`: `Assets/_ImmersiveGames/NewScripts/Infrastructure/World/WorldLifecycleController.cs`
  - `WorldLifecycleBaselineRunner`: `Assets/_ImmersiveGames/NewScripts/Infrastructure/QA/WorldLifecycleBaselineRunner.cs`
  - QA/auto-runner: `Assets/_ImmersiveGames/NewScripts/QA/WorldLifecycleAutoTestRunner.cs`
  - Documentação operacional: `Assets/_ImmersiveGames/NewScripts/Docs/WorldLifecycle/WorldLifecycle.md`
  - Checklist QA: `Assets/_ImmersiveGames/NewScripts/Docs/QA/WorldLifecycle-Baseline-Checklist.md`

- **Como disparar Hard Reset / Soft Reset Players**:
  - Via ContextMenu no `WorldLifecycleController`: `QA/Reset World Now` (hard) e `QA/Soft Reset Players Now` (soft).
  - Via `WorldLifecycleBaselineRunner`: ContextMenus `Run Hard Reset`, `Run Soft Reset Players`, `Run Full Baseline` (F7/F8/F9 em dev). Runner desabilita `AutoInitializeOnStart` do controller quando configurado.
  - Auto-init: `WorldLifecycleController.autoInitializeOnStart` (default `true`) chama `ResetWorldAsync("AutoInitialize/Start")` no `Start()`.

- **Evidências de log esperadas** (trechos curtos):
  - Hard Reset: `[Gate] Acquire token='WorldLifecycle.WorldReset'` → logs de fases `OnBeforeDespawn`/`OnAfterDespawn`/... → `[Gate] Release token='WorldLifecycle.WorldReset'` (`WorldLifecycle-Baseline-Checklist.md`). Controller loga `Reset iniciado` / `Reset concluído` com reason.
  - Soft Reset Players: `[Gate] Acquire token='flow.soft_reset'`; log de `PlayersResetParticipant`; serviços fora do escopo logam `skipped by scope filter`; release do gate (`flow.soft_reset`). Controller loga `Soft reset (Players) iniciado/concluído`.
  - Baseline runner: prefixo `[Baseline]` com `START/END Hard Reset`, `START/END Soft Reset Players`, resumo com sucesso/falha e tempo total.

- **Idempotência/Reentrada**:
  - `WorldLifecycleController` protege reentrância com `_isResetting` (ignora chamadas concorrentes) e valida dependências antes de orquestrar.
  - `WorldLifecycleBaselineRunner` controla `_isRunning` e `_isGateValidationRunning` para evitar execuções paralelas; salva/restaura flags de debug.
  - `WorldLifecycleRuntimeDriver` mantém `_ongoingResetTask` e `_lastContextSignature` para evitar resets duplicados para o mesmo contexto e garante acquire/release de gate (`SimulationGateTokens.Loading`).
  - Orquestrador (`WorldLifecycleOrchestrator`) usa `ISimulationGateService` (`WorldLifecycleTokens.WorldResetToken` para hard; `flow.soft_reset` para soft) e limpa cache/ordem determinística no `finally`, abortando em falhas.

## Tarefa E — Auditoria de documentação (governança)

Arquivos `.md` fora de `Assets/_ImmersiveGames/NewScripts/Docs` e classificação:
- **Pertence ao NewScripts e deveria estar em Docs (1)**: nenhum identificado.
- **Pertence ao legado / não mover (2)**:
  - Documentos nas pastas legadas `Assets/_ImmersiveGames/Scripts/**/Docs` (GameManagerSystems, StateMachineSystems, EaterSystem, Utils, RuntimeAttributeSystems, AudioSystem, PlayerControllerSystem, PlanetSystems, SceneManagement, DetectionsSystems, GameplaySystems, DamageSystem, UISystems, Tests, etc.).
  - Documentos gerais legados em `Assets/_ImmersiveGames/Docs/**` (ADR-001-world-reset-por-respawn, PlanoWorldGame, UTILS-SYSTEMS-GUIDE, Generated/ArchitectureAudit).
  - Documentos de pacote/asset em `Assets/ReplaceSelected`.
  - Documentação raiz do repositório (`README.md`, `LICENSE.md`, `Docs/CHANGELOG.md`).
- **Obsoleto/duplicado (3)**: nenhum claro com evidência; manter até validação com owners.
- **Links quebrados**: nenhuma referência óbvia a paths inexistentes foi encontrada durante a varredura manual; confirmar via validação de links automática em passo futuro.

## Backlog recomendado
- **P0**
  - Habilitar `NEWSCRIPTS_SCENEFLOW_NATIVE` em ambiente de teste e rodar `SceneTransitionServiceSmokeQATester` + `LegacySceneFlowBridgeSmokeQATester` para validar coexistência e preparar remoção do bridge.
  - Corrigir o acoplamento direto ao legado em `Infrastructure/QA/LegacySceneFlowBridgeSmokeQATester.cs` (isolar via interfaces/adapters ou mover para `Bridges/QA`).
- **P1**
  - Automatizar checagem de links/documentos para detectar desvio de governança (scripts para validar que docs do NewScripts residem em `Assets/_ImmersiveGames/NewScripts/Docs`).
  - Adicionar teste editor/CI para garantir que `IsSceneFlowNativeEnabled` está alinhado às symbols configuradas (evitar regressão silenciosa da flag).
- **P2**
  - Consolidar relatório de auditorias (este arquivo e JSON) em pipeline de documentação periódica.
  - Revisar se algum documento legado deve ganhar ponteiro para a documentação do NewScripts (ex.: guias de Utils/DependencySystems apontarem para o DI novo).
